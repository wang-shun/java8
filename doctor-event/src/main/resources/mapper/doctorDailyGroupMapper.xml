<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorDailyGroup">
    <resultMap id="DoctorDailyGroupMap" type="DoctorDailyGroup">
        <id column="id" property="id"/>
        <result column="farm_id" property="farmId"/>
        <result column="group_id" property="groupId"/>
        <result column="type" property="type"/>
        <result column="sum_at" property="sumAt"/>
        <result column="start" property="start"/>
        <result column="wean_count" property="weanCount"/>
        <result column="unwean_count" property="unweanCount"/>
        <result column="inner_in" property="innerIn"/>
        <result column="outer_in" property="outerIn"/>
        <result column="sale" property="sale"/>
        <result column="dead" property="dead"/>
        <result column="weed_out" property="weedOut"/>
        <result column="other_change" property="otherChange"/>
        <result column="chg_farm" property="chgFarm"/>
        <result column="inner_out" property="innerOut"/>
        <result column="outer_out" property="outerOut"/>
        <result column="end" property="end"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>

    </resultMap>

    <sql id="tb">
        doctor_daily_groups
    </sql>

    <sql id="cols_all">
        id, <include refid="cols_exclude_id" />
    </sql>

    <sql id="cols_exclude_id">
        farm_id,
        group_id,
        type,
        sum_at,
        start,
        wean_count,
        unwean_count,
        inner_in,
        outer_in,
        sale,
        dead,
        weed_out,
        other_change,
        chg_farm,
        inner_out,
        outer_out,
        end,
        created_at,
        updated_at

    </sql>

    <sql id="vals">
        #{farmId},
        #{groupId},
        #{type},
        #{sumAt},
        #{start},
        #{weanCount},
        #{unweanCount},
        #{innerIn},
        #{outerIn},
        #{sale},
        #{dead},
        #{weedOut},
        #{otherChange},
        #{chgFarm},
        #{innerOut},
        #{outerOut},
        #{end},
        now(),
        now()

    </sql>

    <sql id="criteria">
        <if test="id != null">AND id = #{id}</if>
        <if test="farmId != null">AND farm_id = #{farmId}</if>
        <if test="groupId != null">AND group_id = #{groupId}</if>
        <if test="type != null">AND type = #{type}</if>
        <if test="sumAt != null">AND sum_at = #{sumAt}</if>
        <if test="start != null">AND start = #{start}</if>
        <if test="weanCount != null">AND wean_count = #{weanCount}</if>
        <if test="unweanCount != null">AND unwean_count = #{unweanCount}</if>
        <if test="innerIn != null">AND inner_in = #{innerIn}</if>
        <if test="outerIn != null">AND outer_in = #{outerIn}</if>
        <if test="sale != null">AND sale = #{sale}</if>
        <if test="dead != null">AND dead = #{dead}</if>
        <if test="weedOut != null">AND weed_out = #{weedOut}</if>
        <if test="otherChange != null">AND other_change = #{otherChange}</if>
        <if test="chgFarm != null">AND chg_farm = #{chgFarm}</if>
        <if test="innerOut != null">AND inner_out = #{innerOut}</if>
        <if test="outerOut != null">AND outer_out = #{outerOut}</if>
        <if test="end != null">AND end = #{end}</if>

    </sql>

    <insert id="create" parameterType="DoctorDailyGroup" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO <include refid="tb" />
        (<include refid="cols_exclude_id" />)
        VALUES
        (<include refid="vals" />)
    </insert>

    <insert id="creates" parameterType="list">
        INSERT INTO <include refid="tb" />
        (<include refid="cols_exclude_id" />)
        VALUES
        <foreach collection="list" separator="," item="item">
            (
                #{item.farmId},
                #{item.groupId},
                #{item.type},
                #{item.sumAt},
                #{item.start},
                #{item.weanCount},
                #{item.unweanCount},
                #{item.innerIn},
                #{item.outerIn},
                #{item.sale},
                #{item.dead},
                #{item.weedOut},
                #{item.otherChange},
                #{item.chgFarm},
                #{item.innerOut},
                #{item.outerOut},
                #{item.end},
            now(),
            now()
            )
        </foreach>
    </insert>

    <select id="findById" parameterType="long" resultMap="DoctorDailyGroupMap" >
        SELECT <include refid="cols_all" /> FROM <include refid="tb" />
        WHERE id = #{id}
    </select>

    <update id="update" parameterType="DoctorDailyGroup">
        UPDATE <include refid="tb"/>
        <set>
            <if test="farmId != null">farm_id = #{farmId},</if>
            <if test="groupId != null">group_id = #{groupId},</if>
            <if test="type != null">type = #{type},</if>
            <if test="sumAt != null">sum_at = #{sumAt},</if>
            <if test="start != null">start = #{start},</if>
            <if test="weanCount != null">wean_count = #{weanCount},</if>
            <if test="unweanCount != null">unwean_count = #{unweanCount},</if>
            <if test="innerIn != null">inner_in = #{innerIn},</if>
            <if test="outerIn != null">outer_in = #{outerIn},</if>
            <if test="sale != null">sale = #{sale},</if>
            <if test="dead != null">dead = #{dead},</if>
            <if test="weedOut != null">weed_out = #{weedOut},</if>
            <if test="otherChange != null">other_change = #{otherChange},</if>
            <if test="chgFarm != null">chg_farm = #{chgFarm},</if>
            <if test="innerOut != null">inner_out = #{innerOut},</if>
            <if test="outerOut != null">outer_out = #{outerOut},</if>
            <if test="end != null">end = #{end},</if>

            updated_at=now()
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM <include refid="tb"/>
        WHERE id = #{id}
    </delete>

    <select id="list" parameterType="map" resultMap="DoctorDailyGroupMap">
        SELECT <include refid="cols_all"/> FROM <include refid="tb"/>
        <where>
            <include refid="criteria"/>
        </where>
    </select>

    <select id="count" parameterType="map" resultType="long">
        SELECT count(1) FROM <include refid="tb"/>
        <where>
            <include refid="criteria"/>
        </where>
    </select>

    <select id="paging" parameterType="map" resultMap="DoctorDailyGroupMap">
        SELECT <include refid="cols_all"/> FROM <include refid="tb"/>
        <where>
            <include refid="criteria"/>
        </where>
        LIMIT #{offset}, #{limit}
    </select>

    <delete id="deleteBySumAt" parameterType="map">
        DELETE FROM <include refid="tb"/>
        WHERE  sum_at = #{sumAt}
    </delete>

    <delete id="deleteByFarmIdAndSumAt" parameterType="map">
        DELETE FROM <include refid="tb"/>
        WHERE farm_id = #{farmId}
        AND sum_at = #{sumAt}
    </delete>

    <select id="getGroupStock" parameterType="map" resultType="io.terminus.doctor.event.model.DoctorGroupStock">
        select
            farm_id,
            sum(case `type` when 7 then `end` else 0 end) as farrowEnd,
            sum(case `type` when 2 then `end` else 0 end) as nurseryEnd,
            sum(case `type` when 3 then `end` else 0 end) as fattenEnd,
            sum(case `type` when 4 then `end` else 0 end) as houbeiEnd
        from doctor_daily_groups
        where farm_id = #{farmId}
        and sum_at = #{sumAt}
        group by farm_id
    </select>

    <select id="getGroupChangeSum" parameterType="map" resultType="io.terminus.doctor.event.model.DoctorGroupChangeSum">
        select
        sum(case when type = 7 and sum_at = #{startAt} then `start` else 0 END) as farrowStart,
        sum(case when type = 7  then `inner_in` else 0 END) as farrowInnerIn,
        sum(case when type = 7  then `outer_in` else 0 END) as farrowOuterIn,
        sum(case when type = 7  then `sale` else 0 END) as farrowSale,
        sum(case when type = 7  then `dead` else 0 END) as farrowDead,
        sum(case when type = 7  then `weed_out` else 0 END) as farrowWeedOut,
        sum(case when type = 7  then `other_change` else 0 END) as farrowOtherChange,
        sum(case when type = 7  then `inner_out` else 0 END) as farrowInnerOut,
        sum(case when type = 7  then `outer_out` else 0 END) as farrowOuterOut,
        sum(case when type = 7 and sum_at = #{endAt} then `end` else 0 END) as farrowEnd,

        sum(case when type = 2 and sum_at = #{startAt} then `start` else 0 END) as nurseryStart,
        sum(case when type = 2  then `inner_in` else 0 END) as nurseryInnerIn,
        sum(case when type = 2  then `outer_in` else 0 END) as nurseryOuterIn,
        sum(case when type = 2  then `sale` else 0 END) as nurserySale,
        sum(case when type = 2  then `dead` else 0 END) as nurseryDead,
        sum(case when type = 2  then `weed_out` else 0 END) as nurseryWeedOut,
        sum(case when type = 2  then `other_change` else 0 END) as nurseryOtherChange,
        sum(case when type = 2  then `inner_out` else 0 END) as nurseryInnerOut,
        sum(case when type = 2  then `outer_out` else 0 END) as nurseryOuterOut,
        sum(case when type = 2 and sum_at = #{endAt} then `end` else 0 END) as nurseryEnd,

        sum(case when type = 3 and sum_at = #{startAt} then `start` else 0 END) as fattenStart,
        sum(case when type = 3  then `inner_in` else 0 END) as fattenInnerIn,
        sum(case when type = 3  then `outer_in` else 0 END) as fattenOuterIn,
        sum(case when type = 3  then `sale` else 0 END) as fattenSale,
        sum(case when type = 3  then `dead` else 0 END) as fattenDead,
        sum(case when type = 3  then `weed_out` else 0 END) as fattenWeedOut,
        sum(case when type = 3  then `other_change` else 0 END) as fattenOtherChange,
        sum(case when type = 3  then `inner_out` else 0 END) as fattenInnerOut,
        sum(case when type = 3  then `outer_out` else 0 END) as fattenOuterOut,
        sum(case when type = 3 and sum_at = #{endAt} then `end` else 0 END) as fattenEnd,

        sum(case when type = 4 and sum_at = #{startAt} then `start` else 0 END) as houbeiStart,
        sum(case when type = 4  then `inner_in` else 0 END) as houbeiInnerIn,
        sum(case when type = 4  then `outer_in` else 0 END) as houbeiOuterIn,
        sum(case when type = 4  then `sale` else 0 END) as houbeiSale,
        sum(case when type = 4  then `dead` else 0 END) as houbeiDead,
        sum(case when type = 4  then `weed_out` else 0 END) as houbeiWeedOut,
        sum(case when type = 4  then `other_change` else 0 END) as houbeiOtherChange,
        sum(case when type = 4  then `inner_out` else 0 END) as houbeiInnerOut,
        sum(case when type = 4  then `outer_out` else 0 END) as houbeiOuterOut,
        sum(case when type = 4 and sum_at = #{endAt} then `end` else 0 END) as houbeiEnd
        from doctor_daily_groups
        where farm_id = #{farmId}
        and sum_at &gt;= #{startAt}
        and sum_at &lt;= #{endAt}
    </select>

    <select id="findByGroupIdAndSumAt" parameterType="map" resultMap="DoctorDailyGroupMap" >
        SELECT <include refid="cols_all"/> FROM <include refid="tb"/>
        WHERE
        group_id = #{groupId}
        AND sum_at = date_format(#{sumAt}, '%Y-%m-%d')
    </select>

    <update id="updateDailyGroupLiveStock" parameterType="map" >
        UPDATE <include refid="tb"/>
        SET start = start + #{changeCount},
        `end` = `end` + #{changeCount}
        WHERE
        group_id = #{groupId}
        AND sum_at &gt;= date_format(#{sumAt}, '%Y-%m-%d')
    </update>
    
    <select id="findFattenWillOut" parameterType="map" resultType="int">
        select
        sum(`end`)
        from doctor_daily_groups a
        left join doctor_group_tracks b on a.group_id = b.group_id
        where a.`type` = 3
          and a.farm_id = 1
          and a.sum_at = #{sumAt}
          and b.birth_date &lt;= date_add(date(#{sumAt}), interval -180 day)    -- 日龄180的育肥猪
    </select>

    <select id="findGroupInfoBySumAt" parameterType="map" resultMap="DoctorDailyGroupMap">
        SELECT <include refid="cols_all"/> FROM <include refid="tb"/>
        WHERE sum_at = #{sumAt}
    </select>

</mapper>