<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="SearchedPig">

    <sql id="criteria">
        <if test="farmId != null"> AND a.farm_id = #{farmId}</if>
        <if test="barnId != null"> AND b.current_barn_id = #{barnId}</if>
        <if test="barnIds != null  &amp;&amp; barnIds.size() > 0"> AND b.current_barn_id IN
            <foreach collection="barnIds" item="barn" open="(" separator="," close=")">
                #{barn}
            </foreach>
        </if>
        <if test="pigTypes != null  &amp;&amp; pigTypes.size() > 0"> AND a.pig_type IN
            <foreach collection="pigTypes" item="type" open="(" separator="," close=")">
                #{type}
            </foreach>
        </if>
        <if test="status != null"> AND b.status = #{status}</if>
        <if test="statuses != null">
             and b.status in
            <foreach collection="statuses" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="all == null">
            <if test="isRemoval != null">
                and b.is_removal = #{isRemoval}
            </if>
            <if test="isRemoval == null">
                and b.is_removal = 0
            </if>
        </if>
        <if test="pigType != null"> AND a.pig_type = #{pigType}</if>
        <if test="pigCode != null"> AND a.pig_code like concat('%', #{pigCode}, '%')</if>
        <if test="precisePigCode !=null">
            AND pig_code=#{precisePigCode}
        </if>
        <if test="boarType != null"> AND a.boar_type = #{boarType}</if>
        <if test="pigIds != null &amp;&amp; pigIds.size() > 0"> AND a.id in
            <foreach collection="pigIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>

        <if test="rfid != null"> AND a.rfid = #{rfid}</if>
    </sql>

    <select id="count" parameterType="map" resultType="long" >
        SELECT count(1) FROM doctor_pigs a
        LEFT JOIN doctor_pig_tracks b
          ON a.id = b.pig_id
        <where>
            <include refid="criteria"/>
        </where>
    </select>

    <select id="paging" parameterType="map" resultType="io.terminus.doctor.event.dto.search.SearchedPig" >
        SELECT
            a.id AS id,
            a.pig_code AS pigCode,
            a.pig_type AS pigType,
            a.farm_id AS farmId,
            a.farm_name AS farmName,
            a.in_farm_date AS inFarmDate,
            b.out_farm_date AS outFarmDate,
            b.status AS status,
            a.breed_id AS breedId,
            a.breed_name AS breedName,
            a.genetic_id AS geneticId,
            a.genetic_name AS geneticName,
            b.current_barn_id AS currentBarnId,
            b.current_barn_name AS currentBarnName,
            a.birth_date AS birthDate,
            b.weight AS weight,
            a.in_farm_day_age AS dayAge,
            b.current_parity AS currentParity,
            a.boar_type as boarType,
            a.rfid as rfid,
            b.weight as pigWeight
        FROM doctor_pigs a
        LEFT JOIN doctor_pig_tracks b
          ON a.id = b.pig_id
        <where>
            <include refid="criteria"/>
        </where>
        ORDER BY
        <if test="pigCode != null">
            instr(pig_code, #{pigCode}) ASC, length(pig_code) ASC, pig_code ASC,
        </if>
        pig_code ASC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="findPigCount" parameterType="long" resultType="io.terminus.doctor.event.dto.search.DoctorPigCountDto">
        select
        ifnull(max(pregCount), 0) pregCount,
        ifnull(max(konghuaiCount),0) konghuaiCount,
        ifnull(max(farrowCount),0) farrowCount
        from (
        SELECT
        (case status when 4 then count(1) end) pregCount,
        (case status when 5 then count(1) end) konghuaiCount ,
        (case status when 8 then count(1) end) farrowCount
        FROM doctor_pig_tracks
        WHERE farm_id = #{farmId}
        GROUP BY status) t
    </select>

    <select id="findBoarPigCount" parameterType="long" resultType="int" >
        SELECT count(1)
        FROM doctor_pig_tracks
        WHERE farm_id = #{farmId}
        AND pig_type = 2
        AND is_removal = 0
    </select>

    <select id="suggestSowPig" parameterType="map" resultType="io.terminus.doctor.event.model.DoctorPig">
        SELECT a.id, a.pig_code as pigCode
        FROM doctor_pigs a left join doctor_pig_tracks b on a.id = b.pig_id
        WHERE b.current_barn_id = #{barnId} AND a.is_removal = 0 AND a.pig_type = 1
        <if test="name != null">AND `pig_code` like concat('%', #{name}, '%')</if>
        ORDER BY instr(`pig_code`, #{name}) ASC, length(`pig_code`) ASC, `pig_code` ASC
        limit #{count}
    </select>

    <select id="findUnRemovalPigsBy" parameterType="long" resultType="io.terminus.doctor.event.model.DoctorPig">
        SELECT a.id, a.pig_code as pigCode, a.rfid
        FROM doctor_pigs a left join doctor_pig_tracks b on a.id = b.pig_id
        WHERE b.current_barn_id = #{barnId} AND a.is_removal = 0 and a.pig_type = 1
    </select>


    <!-- 新增sql : 查询未转场的母猪id -->
    <sql id="where_sql">
        <if test="farmId != null "> AND a.farm_id = #{farmId} </if>
        <if test="barnId != null "> AND b.current_barn_id = #{barnId} </if>
        <if test="status != null "> AND b.status = #{status} </if>
        <if test="pigCode != null and pigCode != '' "> AND a.pig_code like concat('%', #{pigCode}, '%') </if>
        <if test="rfid != null and rfid != '' "> AND a.rfid = #{rfid} </if>
    </sql>

    <select id="findNotTransitionsSow" parameterType="map" resultType="Long" >
        SELECT a.id AS id FROM doctor_pigs a LEFT JOIN doctor_pig_tracks b ON a.id = b.pig_id
        <where>
            <include refid="where_sql"/>
        </where>
        AND a.pig_type = 1
    </select>

    <!-- 新增sql : 查询已转场的母猪id -->
    <sql id="where_sql1">
        <if test="farmId != null"> AND p.farm_id = #{farmId}</if>
    </sql>
    <sql id="where_sql2">
        <if test="farmId != null"> AND c.farm_id = #{farmId}</if>
    </sql>
    <sql id="where_sql3">
        <if test="pigCode != null"> AND p1.pig_code like concat('%', #{pigCode}, '%') </if>
        <if test="barnId != null"> AND p1.init_barn_id = #{barnId} </if>
        <if test="rfid != null"> AND p1.rfid = #{rfid} </if>
    </sql>

    <select id="findHaveTransitionsSow" parameterType="map" resultType="Long">
        select p1.id from doctor_pigs p1 where id in (
        select c.pig_id from doctor_chg_farm_infos c where NOT EXISTS (
        select p.id from doctor_pigs p where c.pig_id = p.id <include refid="where_sql1"/> and c.pig_type = 1
        ) <include refid="where_sql2"/> and c.pig_type = 1
        ) <include refid="where_sql3"/>
    </select>

</mapper>