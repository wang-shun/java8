<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2016 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="DoctorGroupTrack">
    <resultMap id="DoctorGroupTrackMap" type="DoctorGroupTrack">
        <id column="id" property="id"/>
        <result column="group_id" property="groupId"/>
        <result column="rel_event_id" property="relEventId"/>
        <result column="sex" property="sex"/>
        <result column="quantity" property="quantity"/>
        <result column="boar_qty" property="boarQty"/>
        <result column="sow_qty" property="sowQty"/>
        <result column="birth_date" property="birthDate"/>
        <result column="avg_day_age" property="avgDayAge"/>
        <result column="wean_weight" property="weanWeight"/>
        <result column="birth_weight" property="birthWeight"/>
        <result column="nest" property="nest"/>
        <result column="live_qty" property="liveQty"/>
        <result column="healthy_qty" property="healthyQty"/>
        <result column="weak_qty" property="weakQty"/>
        <result column="unwean_qty" property="unweanQty"/>
        <result column="wean_qty" property="weanQty"/>
        <result column="qua_qty" property="quaQty"/>
        <result column="unq_qty" property="unqQty"/>
        <result column="extra" property="extra"/>
        <result column="creator_id" property="creatorId"/>
        <result column="creator_name" property="creatorName"/>
        <result column="updator_id" property="updatorId"/>
        <result column="updator_name" property="updatorName"/>
        <result column="close_at" property="closeAt"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <sql id="tb">
        doctor_group_tracks
    </sql>

    <sql id="cols_all">
        id, <include refid="cols_exclude_id" />
    </sql>

    <sql id="cols_exclude_id">
        group_id,
        rel_event_id,
        sex,
        quantity,
        boar_qty,
        sow_qty,
        birth_date,
        avg_day_age,
        wean_weight,
        birth_weight,
        nest,
        live_qty,
        healthy_qty,
        weak_qty,
        unwean_qty,
        wean_qty,
        qua_qty,
        unq_qty,
        extra,
        creator_id,
        creator_name,
        updator_id,
        updator_name,
        close_at,
        created_at,
        updated_at

    </sql>

    <sql id="vals">
        #{groupId},
        #{relEventId},
        #{sex},
        #{quantity},
        #{boarQty},
        #{sowQty},
        #{birthDate},
        #{avgDayAge},
        #{weanWeight},
        #{birthWeight},
        #{nest},
        #{liveQty},
        #{healthyQty},
        #{weakQty},
        #{unweanQty},
        #{weanQty},
        #{quaQty},
        #{unqQty},
        #{extra},
        #{creatorId},
        #{creatorName},
        #{updatorId},
        #{updatorName},
        #{closeAt},
        now(),
        now()

    </sql>

    <insert id="create" parameterType="DoctorGroupTrack" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO
        <include refid="tb" />
        (<include refid="cols_exclude_id" />)
        VALUES
        (<include refid="vals" />)
    </insert>

    <select id="findById" parameterType="long" resultMap="DoctorGroupTrackMap" >
        SELECT <include refid="cols_all" />
        FROM <include refid="tb" />
        WHERE id = #{id}
    </select>

    <update id="update" parameterType="DoctorGroupTrack">
        UPDATE <include refid="tb"/>
        <set>
            <if test="groupId != null">group_id = #{groupId},</if>
            <if test="relEventId != null">rel_event_id = #{relEventId},</if>
            <if test="sex != null">sex = #{sex},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="boarQty != null">boar_qty = #{boarQty},</if>
            <if test="sowQty != null">sow_qty = #{sowQty},</if>
            <if test="birthDate != null">birth_date = #{birthDate},</if>
            <if test="avgDayAge != null">avg_day_age = #{avgDayAge},</if>
            <if test="weanWeight != null">wean_weight = #{weanWeight},</if>
            <if test="birthWeight != null">birth_weight = #{birthWeight},</if>
            <if test="nest != null">nest = #{nest},</if>
            <if test="liveQty != null">live_qty = #{liveQty},</if>
            <if test="healthyQty != null">healthy_qty = #{healthyQty},</if>
            <if test="weakQty != null">weak_qty = #{weakQty},</if>
            <if test="unweanQty != null">unwean_qty = #{unweanQty},</if>
            <if test="weanQty != null">wean_qty = #{weanQty},</if>
            <if test="quaQty != null">qua_qty = #{quaQty},</if>
            <if test="unqQty != null">unq_qty = #{unqQty},</if>
            <if test="extra != null">extra = #{extra},</if>
            <if test="creatorId != null">creator_id = #{creatorId},</if>
            <if test="creatorName != null">creator_name = #{creatorName},</if>
            <if test="updatorId != null">updator_id = #{updatorId},</if>
            <if test="updatorName != null">updator_name = #{updatorName},</if>
            <if test="closeAt != null">close_at = #{closeAt},</if>
            updated_at=now()
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM <include refid="tb"/>
        WHERE id = #{id}
    </delete>

    <select id="findGroupTrackByGroupId" parameterType="long" resultMap="DoctorGroupTrackMap">
        SELECT <include refid="cols_all" />
        FROM <include refid="tb"/>
        WHERE group_id = #{groupId}
    </select>

    <!-- 计算平均日龄, 求当天和出生日期的时间差 + 1 -->
    <update id="incrDayAge" parameterType="list">
        UPDATE <include refid="tb"/>
        SET avg_day_age = TIMESTAMPDIFF(DAY, birth_date, now()) + 1
        WHERE group_id IN
        <foreach collection="list" item="gid" open="(" separator="," close=")">
            #{gid}
        </foreach>
    </update>

    <!-- search api start -->
    <select id="maxId" resultType="long">
        SELECT MAX(id) FROM
        <include refid="tb"/>
    </select>

    <select id="listSince" parameterType="map" resultMap="DoctorGroupTrackMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE  <![CDATA[
          id < #{lastId} AND updated_at > #{since}
        ]]>
        ORDER BY id DESC LIMIT #{limit}
    </select>
    <!-- search api end -->

    <insert id="creates" parameterType="list">
        INSERT INTO <include refid="tb" />
        (<include refid="cols_exclude_id" />)
        VALUES
        <foreach collection="list" separator="," item="item">
            (
            #{item.groupId},
            #{item.relEventId},
            #{item.sex},
            #{item.quantity},
            #{item.boarQty},
            #{item.sowQty},
            #{item.birthDate},
            #{item.avgDayAge},
            #{item.weanWeight},
            #{item.birthWeight},
            #{item.nest},
            #{item.liveQty},
            #{item.healthyQty},
            #{item.weakQty},
            #{item.unweanQty},
            #{item.weanQty},
            #{item.quaQty},
            #{item.unqQty},
            #{item.extra},
            #{item.creatorId},
            #{item.creatorName},
            #{item.updatorId},
            #{item.updatorName},
            #{item.closeAt},
            now(),
            now()
            )
        </foreach>
    </insert>

    <delete id="deleteGroupTrackByGroupId" parameterType="long">
        DELETE FROM <include refid="tb"/>
        WHERE group_id = #{groupId}
    </delete>

    <select id="queryFattenOutBySumAt" parameterType="map" resultType="map">
        SELECT g.farm_id AS farmId, ifnull(sum(t.quantity), 0) AS fattenOut
        FROM doctor_group_tracks t, doctor_groups g
        WHERE t.group_id = g.id
        AND t.avg_day_age > #{avgDayAge} AND date_format(g.open_at, '%Y-%m-%d') &lt;= #{sumAt} AND g.pig_type = 3
        GROUP BY g.farm_id
    </select>

    <select id="findsByGroups" parameterType="long" resultMap="DoctorGroupTrackMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE
        group_id IN
        <foreach collection="list" item="groupId" open="(" separator="," close=")">
            #{groupId}
        </foreach>
    </select>
    <select id="sumPigletCount" parameterType="int" resultType="int" >
        SELECT sum(quantity) as quantity
        FROM <include refid="tb"/>
        WHERE
        group_id IN
        <foreach collection="list" item="groupId" open="(" separator="," close=")" >
            #{groupId}
        </foreach>
    </select>

    <select id="findSex" parameterType="map" resultType="int">
        select sex as sex
        from  <include refid="tb"/>
        where group_id = #{groupId}
    </select>

</mapper>